# 要件定義書

## 1. 全体要件

### 1.1 システム構成
| 分類 | 要件 |
|------|------|
| **環境** | PoC段階では、PC画面上で要件が動作することを確認できればよい |
| **対象** | 各学年、各クラスごとに本システムが利用できること |
| **考慮外** | 祝日や夏休みなどの長期休暇は考慮不要（土日のみ考慮） |
| **規模** | 各学年2～3クラス、各クラス30名程度を想定 |

---

## 2. 機能要件

## 📌 課題1と課題2の機能区分

本システムの機能は以下のように区分されます：

- **課題1**: 基本機能（必須実装）
- **課題2 - 実装**: 追加機能（実装する）
- **課題2 - 提案**: 将来実装の提案（提案資料のみ）

---

### 2.1 生徒ロール要件

#### 【課題1】R1-S1: 連絡帳の登録・記載
- 生徒ごとに連絡帳の内容を登録できること
- 登録項目:
  - 体調（1〜5段階、必須）
  - メンタル（1〜5段階、必須）
  - 授業振り返り（最大500文字、必須）
  - 部活振り返り（最大500文字、任意）

#### 【課題1】R1-S2: 記録対象日
- 記録対象日は手動で選択可能
- デフォルト値として前登校日（土日を除く前の平日）をシステムが自動算出
- 例：火曜日に提出する場合、月曜日の内容を記載・登録（デフォルト）
- 生徒は必要に応じて記録対象日を変更可能

#### 【課題1】R1-S3: 過去記録の閲覧
- 自身の過去記録を閲覧できること
- 日付、表示順（新しい順/古い順）で絞り込み可能

#### 【課題1】R1-S4: 記録の改変禁止
- 過去の記録を改変することはできない
- 既読処理後は編集不可

#### 【課題1】R1-S5: 過去記録の定義
- 既読処理が行われた時点で「過去記録」の扱いとする

#### 【課題2 - 実装】R2-S1: スタンプ・コメント確認
- 担任からのスタンプ（いいね/すごい/がんばれ/心配）を確認できる
- 担任からのコメントを確認できる

---

### 2.2 担任ロール要件

#### 【課題1】R1-T1: 記録の閲覧
- 提出された連絡帳（生徒の記録）を閲覧できること
- 担当クラスの生徒のみ閲覧可能

#### 【課題1】R1-T2: 既読処理
- 生徒の記録を確認し、既読処理（「いいね！」スタンプ）できること
- 既読処理後、以下を記録:
  - `is_read = true`
  - `read_at = 既読日時`

#### 【課題2 - 実装】R2-T1: 複数スタンプ対応
- 既読処理時にスタンプを選択（必須）:
  - 👍 いいね (good)
  - ⭐ すごい (great)
  - 💪 がんばれ (fighting)
  - 💙 心配 (care)
- 既存の `is_read` は既読判定用として維持
- `stamp_type` で具体的なスタンプを記録
- スタンプ保存と同時に `is_read = true`, `read_at = 現在時刻` を設定

#### 【課題2 - 実装】R2-T2: 生徒へのコメント機能
- 連絡帳に対して生徒へのコメントを記入できる
- コメントは生徒本人のみ閲覧可能
- 最大500文字

#### 【課題2 - 実装】R2-T3: フラグ機能
- 気になる生徒の連絡帳にフラグを設定できる
- フラグ種類:
  - なし (none)
  - ⚠️ 経過観察 (watch)
  - 🚨 要注意 (urgent)
- フラグメモ（気づきメモ）を記録可能
- フラグは上書き保存（履歴は残さない）

#### 【課題2 - 実装】R2-T4: フラグ付き生徒一覧
- フラグが設定された生徒の一覧を確認できる
- フラグ種類、体調、メンタル、最新メモを表示

#### 【課題2 - 実装】R2-T5: 個別生徒推移グラフ
- 生徒の体調・メンタルの推移をグラフで確認できる
- Chart.jsによる折れ線グラフ
- 期間選択（1週間/1ヶ月/3ヶ月）

#### 【課題1】R1-T3: 提出状況の把握
- 1日の生徒全体の提出状況を把握できること
- 表示内容:
  - 提出済み人数 / 総生徒数
  - 既読処理済み人数
  - 未提出人数
  - 未提出者の一覧（赤く表示）

#### 【課題1】R1-T4: 過去記録の閲覧
- 担当クラス内の生徒に関して過去の記録を確認できること
- 過去記録一覧は「本日の記録対象日以外」のデータを表示
- デフォルトで既読済みの記録のみ表示
- 絞り込み条件:
  - 既読ステータス（既読のみ/未読のみ/全て）
  - 生徒名（部分一致）
  - 記録対象日（開始日・終了日）

#### 【課題1】R1-T5: 記録の編集禁止
- 担任は生徒の記録を編集することはできない

#### 【課題2 - 提案】R2-T6: クラス全体統計グラフ
- クラス平均の推移（折れ線グラフ）
- 本日の体調分布（棒グラフ）
- 提出率の推移（折れ線グラフ）
- 注目レベルの生徒数推移（積み上げ棒グラフ）

#### 【課題2 - 提案】R2-T7: 担任間共有メモ
- 担任間でのみ閲覧できるメモを投稿できる
- スレッド形式で複数の教師が意見交換
- 重要度設定（通常/重要/緊急）

#### 【課題2 - 提案】R2-T8: ダッシュボード強化
- 注意が必要な生徒リスト（体調・メンタル2以下）
- フラグ付き生徒一覧
- 未提出者リスト

---

### 2.3 管理者ロール要件

#### 【課題1】R1-A1: アカウント作成
- 生徒、担任アカウントの作成を行うことができる
- 登録項目:
  - 氏名（最大50文字、必須）
  - メールアドレス（最大255文字、必須、一意）
  - 初期パスワード（自動生成8文字、必須）
  - 役割（生徒/担任/管理者、必須）
  - クラス（生徒・担任のみ、必須）

#### 【課題1】R1-A2: クラス・学年割当
- クラス・学年の割り当て、または学年・クラス情報の付与を行うことができる
- 学年: 1〜3年（中学校）
- クラス: A〜B組（PoC用）

#### 【課題2 - 提案】R2-A1: 役割拡張
- 学年主任ロール追加
- 副担任ロール追加
- 役割ごとの権限管理

---

### 2.4 学年主任ロール要件（課題2 - 提案）

#### R2-GL1: 学年全体の閲覧
- 学年全体の連絡帳を閲覧できる
- クラス横断での状況把握

#### R2-GL2: フラグ設定・変更
- 学年内のすべての生徒にフラグを設定できる

#### R2-GL3: 担任間共有メモの閲覧
- 学年内のすべての共有メモを閲覧できる

#### R2-GL4: 学年統計の閲覧
- 学年全体の統計データを確認できる

---

### 2.5 アラート機能要件（課題2 - 提案）

#### R2-ALERT1: 体調異常検知
- 3日連続で体調が2以下の生徒を自動検知
- 担任のダッシュボードに通知表示

#### R2-ALERT2: メンタル異常検知
- 3日連続でメンタルが2以下の生徒を自動検知
- 担任のダッシュボードに通知表示

#### R2-ALERT3: 提出率低下検知
- クラスの提出率が60%以下の場合に通知
- 担任のダッシュボードに通知表示

#### R2-ALERT4: 通知管理
- 通知の既読管理
- 通知一覧の閲覧
- システム内通知（メール送信なし）

---

## 3. 非機能要件

### 3.1 認証・認可
- Laravel Breezeによるセッションベース認証
- ログインID: メールアドレス
- パスワード: 8文字以上
- ロール別アクセス制御:
  - 生徒: 自分の記録のみ
  - 担任: 担当クラスの生徒のみ
  - **【課題2 - 提案】学年主任: 学年全体の生徒**
  - 管理者: 全データ

### 3.2 セキュリティ
- パスワードはハッシュ化して保存
- CSRF保護（Laravel標準）
- ユーザー管理者のみがパスワードリセット可能
- 既読後の記録は編集不可（DB制約またはアプリケーション制御）

### 3.3 性能
- PoCのため、同時接続数は考慮不要
- レスポンス時間: 3秒以内を目安

### 3.4 ブラウザ対応
- **必須**: Microsoft Edge 最新版
- その他ブラウザは考慮外
- **【課題2 - 提案】レスポンシブ対応: スマホ・タブレット**

### 3.5 データ保持
- PoC期間中のデータ保持のみ
- 長期保存は考慮外

---

## 4. データ要件

### 4.1 連絡帳フォーマット（課題1）

| 項目 | 必須/任意 | 入力形式 | データ型 |
|------|----------|---------|---------|
| 記録対象日 | 必須（手動選択可） | DATE | デフォルト値は前登校日、生徒が変更可能 |
| 体調 | 必須 | ラジオボタン（1〜5） | TINYINT |
| メンタル | 必須 | ラジオボタン（1〜5） | TINYINT |
| 授業振り返り | 必須 | テキストエリア（最大500文字） | VARCHAR(500) |
| 部活振り返り | 任意 | テキストエリア（最大500文字） | VARCHAR(500) |

### 4.2 連絡帳フォーマット（課題2追加項目）

| 項目 | 必須/任意 | 入力形式 | データ型 | 実装 |
|------|----------|---------|---------|------|
| スタンプ種類 | 必須（既読処理時） | ENUM | stamp_type | ✅ 実装 |
| スタンプ日時 | 自動 | TIMESTAMP | stamped_at | ✅ 実装 |
| 生徒へのコメント | 任意 | テキストエリア（最大500文字） | TEXT | ✅ 実装 |
| コメント日時 | 自動 | TIMESTAMP | commented_at | ✅ 実装 |
| フラグ | 任意 | ENUM | flag | ✅ 実装 |
| フラグ設定日時 | 自動 | TIMESTAMP | flagged_at | ✅ 実装 |
| フラグ設定者 | 自動 | BIGINT | flagged_by | ✅ 実装 |
| フラグメモ | 任意 | テキストエリア | TEXT | ✅ 実装 |

### 4.3 体調・メンタルの定義

| 数値 | ラベル | 意味 |
|------|-------|------|
| 5 | とても良い | 非常に良い状態 |
| 4 | 良い | 良い状態 |
| 3 | 普通 | 通常の状態 |
| 2 | 悪い | 少し悪い状態 |
| 1 | とても悪い | 非常に悪い状態 |

### 4.4 記録対象日の算出ルール
- 提出日が平日（月〜金）: 提出日の1日前の平日
- 提出日が土日: 直前の金曜日
- 例:
  - 火曜提出 → 月曜分
  - 月曜提出 → 金曜分（土日を飛ばす）

---

## 5. 画面要件

### 5.1 共通画面（1画面）
1. ログイン画面（Breeze標準）
   - パスワードリセットリンクは非表示（ユーザー管理者のみがパスワードリセット可能）

### 5.2 生徒画面（4画面）
1. 生徒ホーム（連絡帳一覧）
2. 連絡帳登録
3. 連絡帳詳細
   - **【課題2 - 実装】スタンプ・コメント表示追加**
4. 絞り込み検索結果

### 5.3 担任画面（課題1: 3画面 → 課題2: 6画面）

#### 課題1の画面
1. 担任ホーム（提出状況サマリー + 本日の提出状況一覧）
2. 連絡帳詳細（既読処理ボタン）
3. 過去記録一覧（絞り込み検索機能付き）

#### 課題2で追加される画面（実装）
4. **【実装】フラグ付き生徒一覧**
5. **【実装】個別生徒推移グラフ**

#### 課題2で追加される画面（提案のみ）
6. **【提案】クラス全体統計グラフ**
7. **【提案】担任間共有メモ詳細**
8. **【提案】通知一覧**

### 5.4 ユーザー管理者画面（7画面）
1. ユーザー管理者ホーム（ユーザー一覧）
2. ユーザー登録
3. ユーザー絞り込み検索結果
4. ユーザー詳細
5. ユーザー編集
6. 学年・クラス管理（一覧表示・削除）
7. 新規学年・クラス登録

### 5.5 学年主任画面（課題2 - 提案）
1. 学年主任ダッシュボード
2. 学年全体の統計グラフ

---

## 6. ビジネスルール

### 6.1 提出ルール
- 同じ生徒が同じ記録対象日の記録を複数提出できない（DB制約: UNIQUE(user_id, entry_date)）
- 記録対象日の当日以降に提出可能

### 6.2 既読処理ルール（課題1）
- 既読処理は担任のみ可能
- 既読処理後、生徒は編集不可
- 既読処理は取り消し不可（PoC要件）

### 6.3 スタンプルール（課題2 - 実装）
- スタンプは既読処理と同時に設定（必須）
- スタンプは上書き可能
- 4種類のスタンプから選択（いいね/すごい/がんばれ/心配）

### 6.4 フラグルール（課題2 - 実装）
- フラグは担任が設定可能
- **【提案】学年主任も設定可能に拡張**
- フラグは上書き保存（履歴は残さない）
- フラグメモも一緒に上書き

### 6.5 アクセス制御（課題2拡張）
- 生徒: 自分の記録のみ閲覧・作成
- 担任: 担当クラスの生徒の記録のみ閲覧・既読処理・フラグ設定
- **【提案】学年主任: 学年全体の生徒の記録閲覧・フラグ設定**
- **【提案】副担任: 担任と同等の権限**
- 管理者: 全ユーザー・クラス管理、パスワードリセット

---

## 7. 制約事項

### 7.1 実装しない機能（PoC範囲外）
- スマホ対応（PCのみ）【課題2で提案】
- メール通知機能【課題2でシステム内通知として提案】
- リアルタイム通知
- 祝日対応
- 長期休暇対応
- 複数クラス担当（担任は1クラスのみ）
- パスワード変更機能（生徒・担任）
- ユーザー削除機能

### 7.2 課題2で実装する機能（12時間）
- ✅ 個別生徒推移グラフ（4h）
- ✅ フラグ機能（3h）
- ✅ 複数スタンプ対応（3h）
- ✅ 生徒へのコメント機能（2h）

### 7.3 課題2で提案のみの機能（提案資料: 5時間）
- 📄 クラス全体統計グラフ
- 📄 担任間共有メモ機能
- 📄 学年主任・副担任ロール
- 📄 アラート機能（体調異常検知、提出率低下）
- 📄 ダッシュボード強化
- 📄 モバイル対応
- 📄 運用ルール整備
